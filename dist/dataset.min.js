function DataSet(t,e){if(t&&!Array.isArray(t)&&(e=t,t=null),this._data=[],this._ids={},this.setOption(e),this.length=0,this._type={},this._mute=!1,this._saved=[],this._options.type)for(var r in this._options.type)if(this._options.type.hasOwnProperty(r)){var i=this._options.type[r];"Date"==i||"ISODate"==i||"ASPDate"==i?this._type[r]="Date":this._type[r]=i}this._subscribers={},this.remove=this.async_call(remove),t&&this.add(t)}function cmpObject(t,e){var r=Object.getOwnPropertyNames(t),i=Object.getOwnPropertyNames(e);if(r.length!=i.length)return!1;for(var n=0;n<r.length;n++){var s=r[n];if(t[s]!==e[s])return!1}return!0}function Util(){function t(t,e,r){var i=e&&r||0,n=0;for(e=e||[],t.toLowerCase().replace(/[0-9a-f]{2}/g,function(t){n<16&&(e[i+n++]=l[t])});n<16;)e[i+n++]=0;return e}function e(t,e){var r=e||0,i=d;return i[t[r++]]+i[t[r++]]+i[t[r++]]+i[t[r++]]+"-"+i[t[r++]]+i[t[r++]]+"-"+i[t[r++]]+i[t[r++]]+"-"+i[t[r++]]+i[t[r++]]+"-"+i[t[r++]]+i[t[r++]]+i[t[r++]]+i[t[r++]]+i[t[r++]]+i[t[r++]]}function r(t,r,i){var n=r&&i||0,s=r||[];t=t||{};var a=void 0!==t.clockseq?t.clockseq:_,o=void 0!==t.msecs?t.msecs:(new Date).getTime(),d=void 0!==t.nsecs?t.nsecs:c+1,l=o-p+(d-c)/1e4;if(l<0&&void 0===t.clockseq&&(a=a+1&16383),(l<0||o>p)&&void 0===t.nsecs&&(d=0),d>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");p=o,c=d,_=a,o+=122192928e5;var h=(1e4*(268435455&o)+d)%4294967296;s[n++]=h>>>24&255,s[n++]=h>>>16&255,s[n++]=h>>>8&255,s[n++]=255&h;var u=o/4294967296*1e4&268435455;s[n++]=u>>>8&255,s[n++]=255&u,s[n++]=u>>>24&15|16,s[n++]=u>>>16&255,s[n++]=a>>>8|128,s[n++]=255&a;for(var v=t.node||f,g=0;g<6;g++)s[n+g]=v[g];return r?r:e(s)}function i(t,r,i){var s=r&&i||0;"string"==typeof t&&(r="binary"==t?new Array(16):null,t=null),t=t||{};var a=t.random||(t.rng||n)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,r)for(var o=0;o<16;o++)r[s+o]=a[o];return r||e(a)}var n,s="undefined"!=typeof window?window:"undefined"!=typeof global?global:null;if(s&&s.crypto&&crypto.getRandomValues){var a=new Uint8Array(16);n=function(){return crypto.getRandomValues(a),a}}if(!n){var o=new Array(16);n=function(){for(var t,e=0;e<16;e++)0===(3&e)&&(t=4294967296*Math.random()),o[e]=t>>>((3&e)<<3)&255;return o}}for(var d=[],l={},h=0;h<256;h++)d[h]=(h+256).toString(16).substr(1),l[d[h]]=h;var u=n(),f=[1|u[0],u[1],u[2],u[3],u[4],u[5]],_=16383&(u[6]<<8|u[7]),p=0,c=0,v=i;v.v1=r,v.v4=i,v.parse=t,v.unparse=e,isNumber=function(t){return t instanceof Number||"number"==typeof t},isString=function(t){return t instanceof String||"string"==typeof t},isDate=function(t){if(t instanceof Date)return!0;if(isString(t)){var e=g.exec(t);if(e)return!0;if(!isNaN(Date.parse(t)))return!0}return!1},convert=function(t,e){var r;if(void 0!==t){if(null===t)return null;if(!e)return t;if("string"!=typeof e&&!(e instanceof String))throw new Error("Type must be a string");switch(e){case"boolean":case"Boolean":return Boolean(t);case"number":case"Number":return Number(t.valueOf());case"string":case"String":return String(t);case"Date":if(isNumber(t))return new Date(t);if(t instanceof Date)return new Date(t.valueOf());if(moment.isMoment(t))return new Date(t.valueOf());if(isString(t))return r=g.exec(t),r?new Date(Number(r[1])):moment(t).toDate();throw new Error("Cannot convert object of type "+getType(t)+" to type Date");case"Moment":if(isNumber(t))return moment(t);if(t instanceof Date)return moment(t.valueOf());if(moment.isMoment(t))return moment(t);if(isString(t))return r=g.exec(t),r?moment(Number(r[1])):moment(t);throw new Error("Cannot convert object of type "+getType(t)+" to type Date");case"ISODate":if(isNumber(t))return new Date(t);if(t instanceof Date)return t.toISOString();if(moment.isMoment(t))return t.toDate().toISOString();if(isString(t))return r=g.exec(t),r?new Date(Number(r[1])).toISOString():new Date(t).toISOString();throw new Error("Cannot convert object of type "+getType(t)+" to type ISODate");case"ASPDate":if(isNumber(t))return"/Date("+t+")/";if(t instanceof Date)return"/Date("+t.valueOf()+")/";if(isString(t)){r=g.exec(t);var i;return i=r?new Date(Number(r[1])).valueOf():new Date(t).valueOf(),"/Date("+i+")/"}throw new Error("Cannot convert object of type "+getType(t)+" to type ASPDate");default:throw new Error('Unknown type "'+e+'"')}}};var g=/^\/?Date\((\-?\d+)/i;getType=function(t){var e=typeof t;return"object"==e?null===t?"null":t instanceof Boolean?"Boolean":t instanceof Number?"Number":t instanceof String?"String":Array.isArray(t)?"Array":t instanceof Date?"Date":"Object":"number"==e?"Number":"boolean"==e?"Boolean":"string"==e?"String":void 0===e?"undefined":e},this.getType=getType,this.convert=convert,this.uuid=v,this.isNumber=isNumber,this.isString=isString}DataSet.prototype.setOption=function(t){this._options=t||{},this._idField=this._options.idField||"id",this._parentField=this._options.parentField||"parent",this._childField=this._options.childField||"nodes",this._orderField=this._options.orderField||"order",this._levelField=this._options.levelField||"level",this._hasChildrenField=this._options.hasChildrenField||"has_children",this._isTree=this._options.tree||!1},DataSet.prototype.on=function(t,e){var r=this._subscribers[t];r||(r=[],this._subscribers[t]=r),r.push({callback:e})},DataSet.prototype.off=function(t,e){var r=this._subscribers[t];r&&(this._subscribers[t]=r.filter(function(t){return t.callback!=e}))},DataSet.prototype.mute=function(t){this._mute=void 0===t||t},DataSet.prototype._trigger=function(t,e,r){if(!this._mute){if("*"==t)throw new Error("Cannot trigger event *");var i=[];t in this._subscribers&&(i=i.concat(this._subscribers[t])),"*"in this._subscribers&&(i=i.concat(this._subscribers["*"]));for(var n=0;n<i.length;n++){var s=i[n];s.callback&&s.callback(t,e,r||null)}}},DataSet.prototype.getId=function(t){return t instanceof Object?t[this._idField]:t},DataSet.prototype.async_call=function(t){var e=this,r=function(r,i){var n;if(i){if("string"==typeof i)n=function(){return $.post(i)};else{if("function"!=typeof i)throw new Error("url should be string or function type");n=i}return $.when(n()).done(function(r){return ret=t.call(e,r.data),ret})}return t.call(e,r)};return r},DataSet.prototype.add=function(t,e){return this._add(t,e,"after")},DataSet.prototype.addFirstChild=function(t,e){return this._add(t,e,"first")},DataSet.prototype._add=function(t,e,r){var i,n,s,a=[],o=this;if(Array.isArray(t))for(var d=0,l=t.length;d<l;d++)n=t[d],o._isTree&&d>0&&n[o._parentField]?(s=o.get(n[o._parentField]),s||(s=e),i=o._addItem(n,s,r)):i=o._addItem(n,e,r),a.push(i),n[o._childField]&&n[o._childField].length>0&&a.concat(o.add(n[o._childField],n[o._idField]));else{if(!(t instanceof Object))throw new Error("Unknown dataType");i=o._addItem(t,e,r),a.push(i),t[o._childField]&&t[o._childField].length>0&&a.concat(o.add(t[o._childField],t[o._idField]))}return a.length&&this._trigger("add",{items:a}),a},DataSet.prototype.insertBefore=function(t,e){return this._insert(t,e,"before")},DataSet.prototype.insertAfter=function(t,e){return this._insert(t,e,"after")},DataSet.prototype._insert=function(t,e,r){var i,n,s=[],a=this;if(index=this.index(e),Array.isArray(t))for(var o=0,d=t.length;o<d;o++)0==o&&(n=a._isTree?t[0][a._levelField]-e[a._levelField]:0),"before"==r?i=a._insertItem(t[o],index+o,"before",n):(i=a._insertItem(t[o],index,"after",n),index=i.index),s.push(i.id);else{if(!(t instanceof Object))throw new Error("Unknown dataType");i="before"==r?a._insertItem(t,index,"before"):a._insertItem(t,index,"after"),s.push(i.id)}return this._resetIds(index),s.length&&this._trigger("add",{items:s}),s},DataSet.prototype._insertItem=function(t,e,r,i){var n=t[this._idField],s=this._data[e];if(i=void 0==i?0:i,void 0!=n){if(this._ids.hasOwnProperty(n))throw new Error("Cannot add item: item with id "+n+" already exists")}else n=util.uuid.v4(),t[this._idField]=n;var a={};for(var o in t)if(t.hasOwnProperty(o)){var d=this._type[o];a[o]=util.convert(t[o],d)}"before"==r?this._data.splice(e,0,a):(e=this._findNext(e),e==-1?(this._data.push(a),e=this.length):this._data.splice(e,0,a));var l,h,u;return this._isTree&&(a[this._parentField]=s[this._parentField],a[this._levelField]||(a[this._levelField]=s[this._levelField]),"after"==r?a[this._orderField]=s[this._orderField]+1:a[this._orderField]=s[this._orderField],h=s[this._levelField],u=s[this._parentField],l=a[this._orderField],this._reOrder(e+1,h,l)),this.length++,{id:n,index:e}},DataSet.prototype._reOrder=function(t,e,r){var i,n,s,a;for(i=t,n=this.length;i<n;i++)if(s=this._data[i],a=s[this._levelField],!(a>e)){if(a!=e)break;s[this._orderField]<=r&&(r++,s[this._orderField]=r)}},DataSet.prototype.move=function(t,e,r){return this._move(t,e,r)},DataSet.prototype._resetLevel=function(t,e){for(var r,i=this,n=0,s=t.length;n<s;n++)0==n&&(r=t[n][i._levelField]-e),t[n][i._levelField]-=r},DataSet.prototype._move=function(t,e,r){var i,n,s,a,o,d,l=this,h=[];if(l.isChild(e,t))throw new Error("Target nodes could not be child");if(l.getId(t)!=l.getId(e)){l.mute(!0),i=l.index(t),n=l._findNext(i),a=n==-1?l.length-i:n-i,s=l._data.splice(i,a),l.length-=s.length,l._resetParent(i),l._resetIds(),"before"==r?(d=e[l._levelField],l._resetLevel(s,d),o=l.insertBefore(s,e)):"after"==r?(d=e[l._levelField],l._resetLevel(s,d),o=l.insertAfter(s,e)):"child"==r&&(d=e[l._levelField]+1,l._resetLevel(s,d),o=l.add(s,e));for(var u=0,f=o.length;u<f;u++)h.push(o[u]);return l.mute(!1),h.length&&l._trigger("update",{items:h}),h}},DataSet.prototype._findNext=function(t){var e=t+1;if(e>=this.length)return-1;if(this._isTree){var r,i,n,s,a=this._data[t];for(r=a[this._levelField],n=e,s=this.length;n<s&&(i=this._data[n][this._levelField],i>r);n++);return n>=this.length?-1:n}return e},DataSet.prototype.load=function(t,e){var r=this;return this._data=[],this._ids={},this.length=0,"string"==typeof t?$.getJSON(t||this._options.url).done(function(t){r.mute(),e?r.add(e(t)):r.add(t),r.mute(!1),r._trigger("load")}):(r.mute(),e?r.add(e(t)):r.add(t),r.mute(!1),r._trigger("load"),void 0)},DataSet.prototype.load_tree=function(t,e){var r=this,i={};if(this._data=[],this._ids={},this.length=0,"string"==typeof t)return $.getJSON(t||this._options.url).done(function(t){e?r.add(e(t)):r.add(t)});"function"==typeof e?r.add(e(t)):r.add(t),e instanceof Object&&(i=e),i.plain=!0;var n=r.tree(i);this._data=[],this._ids={},this.length=0,this.mute(),r.add(n),this.mute(!1),r._trigger("load")},DataSet.prototype.isChild=function(t,e){var r,i=this;if(i._isTree)for(r=t[i._parentField];r;){if(i.getId(r)==i.getId(e))return!0;r=r[i._parentField]}},DataSet.prototype.update=function(t,e){var r=[],i=[],n=[],s=this,a=s._idField,o=function(t){var e=t[a];s._ids.hasOwnProperty(e)?(e=s._updateItem(t),i.push(e),n.push(t)):(e=s._addItem(t),r.push(e))};if(Array.isArray(t))for(var d=0,l=t.length;d<l;d++)o(t[d]);else{if(!(t instanceof Object))throw new Error("Unknown dataType");o(t)}return r.length&&this._trigger("add",{items:r},e),i.length&&this._trigger("update",{items:i,data:n},e),r.concat(i)},DataSet.prototype.get=function(t){var e=this;if(!t)return e._data;var r,i,n,s=util.getType(arguments[0]);"String"==s||"Number"==s?(r=arguments[0],n=arguments[1]):"Array"==s?(i=arguments[0],n=arguments[1]):n=arguments[0];var a;if(n&&n.returnType){var o=["Array","Object"];a=o.indexOf(n.returnType)==-1?"Array":n.returnType}else a="Array";var d,l,h,u,f=n&&n.type||this._options.type,_=n&&n.filter,p=[];if(void 0!=r)d=e._getItem(r,f),_&&!_(d)&&(d=null);else if(void 0!=i)for(h=0,u=i.length;h<u;h++)d=e._getItem(i[h],f),_&&!_(d)||p.push(d);else if(_)for(l in this._ids)d=e._getItem(l,f),_&&!_(d)||p.push(d);else p=this._data.slice();if(n&&n.order&&void 0==r&&this._sort(p,n.order),n&&n.fields){var c=n.fields;if(void 0!=r)d=this._filterFields(d,c);else for(h=0,u=p.length;h<u;h++)p[h]=this._filterFields(p[h],c)}if("Object"==a){var v={};for(h=0;h<p.length;h++)v[p[h].id]=p[h];return v}return void 0!=r?d:p},DataSet.prototype.tree=function(t){function e(t,r){for(var i,n,s=1,o=0,d=t.length;o<d;o++)i=t[o],i[v]=i[v]||r,i[orderField]?s<i[orderField]?s=i[orderField]:s==i[orderField]?i[orderField]++:i[orderField]=s:i[orderField]=s,s++,c.push(i),n=i[a],n&&n.length>0&&(i[g]=!0,delete i[a],e(n,r+1))}var r,i,n,s,a,o,d=this,l={},h=[],u=[],t=t||{};s=t.parentField||d._parentField,a=t.childrenField||d._childField,idField=t.idField||d._idField,orderField=t.orderField||d._orderField,u.push(t.parentField||d._parentField),u.push(orderField);for(var f=this.get({order:u}),_=0,p=f.length;_<p;_++){i={},n=f[_];for(k in n)i[k]=n[k];r=i[idField],parentId=i[s]||0,parentId?(o=l[parentId],o.hasOwnProperty(a)?o[a].push(i):o[a]=[i]):h.push(i),l[r]=i}if(t.plain){var c=[],v=t.levelField||d._levelField,g=t.hasChildrenField||d._hasChildrenField,u=t.order;return e(h,0,1),c}return h},DataSet.prototype.getIds=function(t){var e,r,i,n,s,a=this._data,o=t&&t.filter,d=t&&t.order,l=t&&t.type||this._options.type,h=[];if(o)if(d){s=[];for(i in a)a.hasOwnProperty(i)&&(n=this._getItem(i,l),o(n)&&s.push(n));for(this._sort(s,d),e=0,r=s.length;e<r;e++)h[e]=s[e][this._idField]}else for(i in a)a.hasOwnProperty(i)&&(n=this._getItem(i,l),o(n)&&h.push(n[this._idField]));else if(d){s=[];for(i in a)a.hasOwnProperty(i)&&s.push(a[i]);for(this._sort(s,d),e=0,r=s.length;e<r;e++)h[e]=s[e][this._idField]}else for(i in a)a.hasOwnProperty(i)&&(n=a[i],h.push(n[this._idField]));return h},DataSet.prototype.getDataSet=function(){return this},DataSet.prototype.forEach=function(t,e){var r,i=e&&e.filter,n=(e&&e.type||this._options.type,this._data);this._ids;if(e&&e.order)for(var s=this.get(e),a=0,o=s.length;a<o;a++)r=s[a],t(r,a);else for(var a=0,o=n.length;a<o;a++)r=n[a],i&&!i(r)||t(r,a)},DataSet.prototype.map=function(t,e){for(var r,i,n=e&&e.filter,s=(e&&e.type||this._options.type,[]),a=this._data,o=a.length;i<o;i++)r=a[i],n&&!n(r)||s.push(t(r,id));return e&&e.order&&this._sort(s,e.order),s},DataSet.prototype._filterFields=function(t,e){if(!t)return t;var r={};if(Array.isArray(e))for(var i in t)t.hasOwnProperty(i)&&e.indexOf(i)!=-1&&(r[i]=t[i]);else for(var i in t)t.hasOwnProperty(i)&&e.hasOwnProperty(i)&&(r[e[i]]=t[i]);return r},DataSet.prototype._by=function(t,e,r){return e=e||!1,function(i,n){var s,a;if("object"==typeof i&&"object"==typeof n&&i&&n)return s=i[t],a=n[t],s===a?"function"==typeof r?r(i,n):0:typeof s==typeof a?e?s<a?1:-1:s<a?-1:1:0;throw"error"}};var mergesort=function(t,e){function r(r,i,n){"use asm";var s=i-r,a=n-i;var o=t.slice(r,i),d=t.slice(i,n);var l=r,h=0,u=0;while(h<s&&u<a)if(e(o[h],d[u])<=0)t[l++]=o[h++];else t[l++]=d[u++];while(h<s)t[l++]=o[h++];while(u<a)t[l++]=d[u++];return}function i(n,s){"use asm";var a=s-n;if(a<=8){var o=t.slice(n,s);o.sort(e);for(var d=0;d<a;++d)t[n+d]=o[d];return}var l=n+Math.floor(a/2);i(n,l);i(l,s);r(n,l,s)}return void 0===e&&(e=function(t,e){"use asm";return t<e?-1:t===e?0:1}),i(0,t.length),t};DataSet.prototype._sort=function(t,e){if(util.isString(e)||Array.isArray(e)){var r,i,n,s,a=null,o=this;r=util.isString(e)?[e]:e;for(var d=r.length-1;d>-1;d--)i=r[d],i&&"-"===i.charAt(0)?(s=!0,i=i.substr(1)):s=!1,n=a?o._by(i,s,a):o._by(i,s),a=n;return mergesort(t,n)}if("function"==typeof e)return mergesort(t,e);throw new TypeError("Order must be a function or a string")},remove=function(t){var e,r,i,n=[],s=0,a=this,o=function(t){var e,r,i,o;if(t&&(r="string"==typeof t||"number"==typeof t?a.get(t):t,r&&(t=r[a._idField],n.indexOf(t)===-1&&(e=a.index(t),i=r[a._levelField],n.push(t),a._data.splice(e,1),a.length--,a._resetIds(s),a._isTree)))){for(var d=e,l=a.length;d<l&&(o=a._data[e],o[a._levelField]>i);d++)n.push(o[a._idField]),a._data.splice(e,1),a.length--;a._resetParent(e)}};if(Array.isArray(t))for(e=0,r=t.length;e<r;e++)i=o(t[e]);else i=o(t);return this._resetIds(s),n.length&&this._trigger("remove",{items:n}),n},DataSet.prototype._resetParent=function(t){var e,r=this;t-1>-1&&(e=r._data[t-1],e[r._hasChildrenField]&&(t<r.length?e[r._hasChildrenField]=r._data[t][r._levelField]>e[r._levelField]:e[r._hasChildrenField]=!1))},DataSet.prototype._resetIds=function(t){t instanceof Object&&(t=t[this._idField]),t||(t=0),this._ids={};for(var e=0,r=this.length;e<r;e++)this._ids[this._data[e][this._idField]]=e},DataSet.prototype.clear=function(t){var e=Object.keys(this._ids);return this._data=[],this._ids={},this.length=0,this._trigger("remove",{items:e},t),e},DataSet.prototype._addItem=function(t,e,r){var i=t[this._idField];if(void 0!=i){if(this._ids.hasOwnProperty(i))throw new Error("Cannot add item: item with id "+i+" already exists")}else i=util.uuid.v4(),t[this._idField]=i;var n={};for(var s in t)if(t.hasOwnProperty(s)){var a=this._type[s];n[s]=util.convert(t[s],a)}e&&this._isTree||(this._data.push(n),this.length++,this._ids[i]=this.length-1);var o,d;return this._isTree&&(e?(d=this.index(e),e=this._data[d],n[this._parentField]=e[this._idField],n[this._levelField]||(n[this._levelField]=e[this._levelField]+1),e[this._hasChildrenField]=!0,o=this._getFirstChild(e),o?"first"==r?(n[this._orderField]=this._data[d+1][this._orderField],this._data.splice(d+1,0,n),level=n[this._levelField],last_order=n[this._orderField],this._reOrder(d+1,level,last_order)):(d=this._findNext(d),d==-1?(this._data.push(n),order=this._data[this.length-1][this._orderField]+1,d=this._data.length):(order=this._data[d-1][this._orderField]+1,this._data.splice(d,0,n)),n[this._orderField]=order):(n[this._orderField]=1,this._data.splice(d+1,0,n)),this.length++,this._resetIds()):n[this._levelField]||(n[this._levelField]=0)),i},DataSet.prototype._getFirstChild=function(t){var e,r=t[this._levelField],i=this.index(t);if(i+1<this.length&&(e=this._data[i+1],e[this._levelField]>r))return e},DataSet.prototype.index=function(t){var e;return util.isNumber(t)||util.isString(t)?e=t:t instanceof Object&&(e=t[this._idField]),this._ids[e]},DataSet.prototype._getItem=function(t,e){var r,i,n=this._ids[t],s=this._data[n];if(!s)return null;var a={};if(e)for(r in s)s.hasOwnProperty(r)&&(i=s[r],a[r]=util.convert(i,e[r]));else for(r in s)s.hasOwnProperty(r)&&(i=s[r],a[r]=i);return a},DataSet.prototype.save=function(){return this._saved=$.extend(!0,[],this.get({order:[this._idField]})),this._saved},DataSet.prototype.diff=function(t){t=t||this._saved;for(var e,r,i,n,s=this.get({order:[this._idField]}),a=0,o=0,d=s.length,l=t.length,h=[],u=[],f=[];a<d&&o<l;)e=s[a],r=t[o],i=e[this._idField],n=r[this._idField],i==n?(cmpObject(e,r)||h.push(e),a++,o++):i<n?(u.push(e),a++):(f.push(r),o++);for(;a<d;a++)u.push(s[a]);for(;o<l;o++)f.push(t[o]);return{added:u,updated:h,deleted:f}},DataSet.prototype._updateItem=function(t){var e=t[this._idField];if(void 0==e)throw new Error("Cannot update item: item has no id (item: "+JSON.stringify(t)+")");var r=this._ids[e],i=this._data[r];if(!i)throw new Error("Cannot update item: no item with id "+e+" found");for(var n in t){var s=this._type[n];i[n]=util.convert(t[n],s)}return e};var util=new Util;