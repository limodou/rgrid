function DataSet(e,t){if(e&&!Array.isArray(e)&&(t=e,e=null),this._options=t||{},this._data=[],this._ids={},this.length=0,this._idField=this._options.idField||"id",this._parentField=this._options.parentField||"_parent",this._childField=this._options.childField||"nodes",this._orderField=this._options.orderField||"order",this._levelField=this._options.levelField||"level",this._hasChildrenField=this._options.hasChildrenField||"has_children",this._isTree=this._options.tree||!1,this._type={},this._mute=!1,this._options.type)for(var r in this._options.type)if(this._options.type.hasOwnProperty(r)){var i=this._options.type[r];"Date"==i||"ISODate"==i||"ASPDate"==i?this._type[r]="Date":this._type[r]=i}this._subscribers={},this.remove=this.async_call(remove),e&&this.add(e)}function Util(){function e(e,t,r){var i=t&&r||0,n=0;for(t=t||[],e.toLowerCase().replace(/[0-9a-f]{2}/g,function(e){n<16&&(t[i+n++]=l[e])});n<16;)t[i+n++]=0;return t}function t(e,t){var r=t||0,i=d;return i[e[r++]]+i[e[r++]]+i[e[r++]]+i[e[r++]]+"-"+i[e[r++]]+i[e[r++]]+"-"+i[e[r++]]+i[e[r++]]+"-"+i[e[r++]]+i[e[r++]]+"-"+i[e[r++]]+i[e[r++]]+i[e[r++]]+i[e[r++]]+i[e[r++]]+i[e[r++]]}function r(e,r,i){var n=r&&i||0,s=r||[];e=e||{};var o=void 0!==e.clockseq?e.clockseq:_,a=void 0!==e.msecs?e.msecs:(new Date).getTime(),d=void 0!==e.nsecs?e.nsecs:c+1,l=a-p+(d-c)/1e4;if(l<0&&void 0===e.clockseq&&(o=o+1&16383),(l<0||a>p)&&void 0===e.nsecs&&(d=0),d>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");p=a,c=d,_=o,a+=122192928e5;var h=(1e4*(268435455&a)+d)%4294967296;s[n++]=h>>>24&255,s[n++]=h>>>16&255,s[n++]=h>>>8&255,s[n++]=255&h;var f=a/4294967296*1e4&268435455;s[n++]=f>>>8&255,s[n++]=255&f,s[n++]=f>>>24&15|16,s[n++]=f>>>16&255,s[n++]=o>>>8|128,s[n++]=255&o;for(var v=e.node||u,y=0;y<6;y++)s[n+y]=v[y];return r?r:t(s)}function i(e,r,i){var s=r&&i||0;"string"==typeof e&&(r="binary"==e?new Array(16):null,e=null),e=e||{};var o=e.random||(e.rng||n)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,r)for(var a=0;a<16;a++)r[s+a]=o[a];return r||t(o)}var n,s="undefined"!=typeof window?window:"undefined"!=typeof global?global:null;if(s&&s.crypto&&crypto.getRandomValues){var o=new Uint8Array(16);n=function(){return crypto.getRandomValues(o),o}}if(!n){var a=new Array(16);n=function(){for(var e,t=0;t<16;t++)0===(3&t)&&(e=4294967296*Math.random()),a[t]=e>>>((3&t)<<3)&255;return a}}for(var d=[],l={},h=0;h<256;h++)d[h]=(h+256).toString(16).substr(1),l[d[h]]=h;var f=n(),u=[1|f[0],f[1],f[2],f[3],f[4],f[5]],_=16383&(f[6]<<8|f[7]),p=0,c=0,v=i;v.v1=r,v.v4=i,v.parse=e,v.unparse=t,isNumber=function(e){return e instanceof Number||"number"==typeof e},isString=function(e){return e instanceof String||"string"==typeof e},isDate=function(e){if(e instanceof Date)return!0;if(isString(e)){var t=y.exec(e);if(t)return!0;if(!isNaN(Date.parse(e)))return!0}return!1},convert=function(e,t){var r;if(void 0!==e){if(null===e)return null;if(!t)return e;if("string"!=typeof t&&!(t instanceof String))throw new Error("Type must be a string");switch(t){case"boolean":case"Boolean":return Boolean(e);case"number":case"Number":return Number(e.valueOf());case"string":case"String":return String(e);case"Date":if(isNumber(e))return new Date(e);if(e instanceof Date)return new Date(e.valueOf());if(moment.isMoment(e))return new Date(e.valueOf());if(isString(e))return r=y.exec(e),r?new Date(Number(r[1])):moment(e).toDate();throw new Error("Cannot convert object of type "+getType(e)+" to type Date");case"Moment":if(isNumber(e))return moment(e);if(e instanceof Date)return moment(e.valueOf());if(moment.isMoment(e))return moment(e);if(isString(e))return r=y.exec(e),r?moment(Number(r[1])):moment(e);throw new Error("Cannot convert object of type "+getType(e)+" to type Date");case"ISODate":if(isNumber(e))return new Date(e);if(e instanceof Date)return e.toISOString();if(moment.isMoment(e))return e.toDate().toISOString();if(isString(e))return r=y.exec(e),r?new Date(Number(r[1])).toISOString():new Date(e).toISOString();throw new Error("Cannot convert object of type "+getType(e)+" to type ISODate");case"ASPDate":if(isNumber(e))return"/Date("+e+")/";if(e instanceof Date)return"/Date("+e.valueOf()+")/";if(isString(e)){r=y.exec(e);var i;return i=r?new Date(Number(r[1])).valueOf():new Date(e).valueOf(),"/Date("+i+")/"}throw new Error("Cannot convert object of type "+getType(e)+" to type ASPDate");default:throw new Error('Unknown type "'+t+'"')}}};var y=/^\/?Date\((\-?\d+)/i;getType=function(e){var t=typeof e;return"object"==t?null===e?"null":e instanceof Boolean?"Boolean":e instanceof Number?"Number":e instanceof String?"String":Array.isArray(e)?"Array":e instanceof Date?"Date":"Object":"number"==t?"Number":"boolean"==t?"Boolean":"string"==t?"String":void 0===t?"undefined":t},this.getType=getType,this.convert=convert,this.uuid=v,this.isNumber=isNumber,this.isString=isString}DataSet.prototype.on=function(e,t){var r=this._subscribers[e];r||(r=[],this._subscribers[e]=r),r.push({callback:t})},DataSet.prototype.off=function(e,t){var r=this._subscribers[e];r&&(this._subscribers[e]=r.filter(function(e){return e.callback!=t}))},DataSet.prototype.mute=function(e){this._mute=void 0===e||e},DataSet.prototype._trigger=function(e,t,r){if(!this._mute){if("*"==e)throw new Error("Cannot trigger event *");var i=[];e in this._subscribers&&(i=i.concat(this._subscribers[e])),"*"in this._subscribers&&(i=i.concat(this._subscribers["*"]));for(var n=0;n<i.length;n++){var s=i[n];s.callback&&s.callback(e,t,r||null)}}},DataSet.prototype.getId=function(e){return e instanceof Object?e[this._idField]:e},DataSet.prototype.async_call=function(e){var t=this,r=function(r,i){var n;if(i){if("string"==typeof i)n=function(){return $.post(i)};else{if("function"!=typeof i)throw new Error("url should be string or function type");n=i}return $.when(n()).done(function(r){return ret=e.call(t,r.data),ret})}return e.call(t,r)};return r},DataSet.prototype.add=function(e,t){return this._add(e,t,"after")},DataSet.prototype.addFirstChild=function(e,t){return this._add(e,t,"first")},DataSet.prototype._add=function(e,t,r){var i,n,s,o=[],a=this;if(Array.isArray(e))for(var d=0,l=e.length;d<l;d++)n=e[d],a._isTree&&d>0&&n[a._parentField]?(s=a.get(n[a._parentField]),s||(s=t),i=a._addItem(n,s,r)):i=a._addItem(n,t,r),o.push(i),n[a._childField]&&n[a._childField].length>0&&o.concat(a.add(n[a._childField],n[a._idField]));else{if(!(e instanceof Object))throw new Error("Unknown dataType");i=a._addItem(e,t,r),o.push(i),e[a._childField]&&e[a._childField].length>0&&o.concat(a.add(e[a._childField],e[a._idField]))}return o.length&&this._trigger("add",{items:o}),o},DataSet.prototype.insertBefore=function(e,t){return this._insert(e,t,"before")},DataSet.prototype.insertAfter=function(e,t){return this._insert(e,t,"after")},DataSet.prototype._insert=function(e,t,r){var i,n,s=[],o=this;if(index=this.index(t),Array.isArray(e))for(var a=0,d=e.length;a<d;a++)0==a&&(n=o._isTree?e[0][o._levelField]-t[o._levelField]:0),"before"==r?i=o._insertItem(e[a],index+a,"before",n):(i=o._insertItem(e[a],index,"after",n),index=i.index),s.push(i.id);else{if(!(e instanceof Object))throw new Error("Unknown dataType");i="before"==r?o._insertItem(e,index,"before"):o._insertItem(e,index,"after"),s.push(i.id)}return this._resetIds(index),s.length&&this._trigger("add",{items:s}),s},DataSet.prototype._insertItem=function(e,t,r,i){var n=e[this._idField],s=this._data[t];if(i=void 0==i?0:i,void 0!=n){if(this._ids.hasOwnProperty(n))throw new Error("Cannot add item: item with id "+n+" already exists")}else n=util.uuid.v4(),e[this._idField]=n;var o={};for(var a in e)if(e.hasOwnProperty(a)){var d=this._type[a];o[a]=util.convert(e[a],d)}"before"==r?this._data.splice(t,0,o):(t=this._findNext(t),t==-1?(this._data.push(o),t=this.length):this._data.splice(t,0,o));var l,h,f;return this._isTree&&(o[this._parentField]=s[this._parentField],o[this._levelField]||(o[this._levelField]=s[this._levelField]),"after"==r?o[this._orderField]=s[this._orderField]+1:o[this._orderField]=s[this._orderField],h=s[this._levelField],f=s[this._parentField],l=o[this._orderField],this._reOrder(t+1,h,l)),this.length++,{id:n,index:t}},DataSet.prototype._reOrder=function(e,t,r){var i,n,s,o;for(i=e,n=this.length;i<n;i++)if(s=this._data[i],o=s[this._levelField],!(o>t)){if(o!=t)break;s[this._orderField]<=r&&(r++,s[this._orderField]=r)}},DataSet.prototype.move=function(e,t,r){return this._move(e,t,r)},DataSet.prototype._resetLevel=function(e,t){for(var r,i=this,n=0,s=e.length;n<s;n++)0==n&&(r=e[n][i._levelField]-t),e[n][i._levelField]-=r},DataSet.prototype._move=function(e,t,r){var i,n,s,o,a,d,l=this,h=[];if(l.isChild(t,e))throw new Error("Target nodes could not be child");if(l.getId(e)!=l.getId(t)){l.mute(!0),i=l.index(e),n=l._findNext(i),o=n==-1?l.length-i:n-i,s=l._data.splice(i,o),l.length-=s.length,l._resetParent(i),l._resetIds(),"before"==r?(d=t[l._levelField],l._resetLevel(s,d),a=l.insertBefore(s,t)):"after"==r?(d=t[l._levelField],l._resetLevel(s,d),a=l.insertAfter(s,t)):"child"==r&&(d=t[l._levelField]+1,l._resetLevel(s,d),a=l.add(s,t));for(var f=0,u=a.length;f<u;f++)h.push(a[f]);return l.mute(!1),h.length&&l._trigger("update",{items:h}),h}},DataSet.prototype._findNext=function(e){var t=e+1;if(t>=this.length)return-1;if(this._isTree){var r,i,n,s,o=this._data[e];for(r=o[this._levelField],n=t,s=this.length;n<s&&(i=this._data[n][this._levelField],i>r);n++);return n>=this.length?-1:n}return t},DataSet.prototype.load=function(e,t){var r=this;return this._data=[],this._ids={},this.length=0,"string"==typeof e?$.getJSON(e||this._options.url).done(function(e){r.mute(),t?r.add(t(e)):r.add(e),r.mute(!1),r._trigger("load")}):(r.mute(),t?r.add(t(e)):r.add(e),r.mute(!1),r._trigger("load"),void 0)},DataSet.prototype.load_tree=function(e,t){var r=this,i={};if(this._data=[],this._ids={},this.length=0,"string"==typeof e)return $.getJSON(e||this._options.url).done(function(e){t?r.add(t(e)):r.add(e)});"function"==typeof t?r.add(t(e)):r.add(e),t instanceof Object&&(i=t),i.plain=!0;var n=r.tree(i);this._data=[],this._ids={},this.length=0,r.add(n)},DataSet.prototype.isChild=function(e,t){var r,i=this;if(i._isTree)for(r=e[i._parentField];r;){if(i.getId(r)==i.getId(t))return!0;r=r[i._parentField]}},DataSet.prototype.update=function(e,t){var r=[],i=[],n=[],s=this,o=s._idField,a=function(e){var t=e[o];s._ids.hasOwnProperty(t)?(t=s._updateItem(e),i.push(t),n.push(e)):(t=s._addItem(e),r.push(t))};if(Array.isArray(e))for(var d=0,l=e.length;d<l;d++)a(e[d]);else{if(!(e instanceof Object))throw new Error("Unknown dataType");a(e)}return r.length&&this._trigger("add",{items:r},t),i.length&&this._trigger("update",{items:i,data:n},t),r.concat(i)},DataSet.prototype.get=function(e){var t=this;if(!e)return t._data;var r,i,n,s=util.getType(arguments[0]);"String"==s||"Number"==s?(r=arguments[0],n=arguments[1]):"Array"==s?(i=arguments[0],n=arguments[1]):n=arguments[0];var o;if(n&&n.returnType){var a=["Array","Object"];o=a.indexOf(n.returnType)==-1?"Array":n.returnType}else o="Array";var d,l,h,f,u=n&&n.type||this._options.type,_=n&&n.filter,p=[];if(void 0!=r)d=t._getItem(r,u),_&&!_(d)&&(d=null);else if(void 0!=i)for(h=0,f=i.length;h<f;h++)d=t._getItem(i[h],u),_&&!_(d)||p.push(d);else if(_)for(l in this._ids)d=t._getItem(l,u),_&&!_(d)||p.push(d);else p=this._data.slice();if(n&&n.order&&void 0==r&&this._sort(p,n.order),n&&n.fields){var c=n.fields;if(void 0!=r)d=this._filterFields(d,c);else for(h=0,f=p.length;h<f;h++)p[h]=this._filterFields(p[h],c)}if("Object"==o){var v={};for(h=0;h<p.length;h++)v[p[h].id]=p[h];return v}return void 0!=r?d:p},DataSet.prototype.tree=function(e){function t(e,r){for(var i,n,s=1,a=0,d=e.length;a<d;a++)i=e[a],i[v]=i[v]||r,i[orderField]?s<i[orderField]?s=i[orderField]:s==i[orderField]?i[orderField]++:i[orderField]=s:i[orderField]=s,s++,c.push(i),n=i[o],n&&n.length>0&&(i[y]=!0,delete i[o],t(n,r+1))}var r,i,n,s,o,a,d=this,l={},h=[],f=[],e=e||{};s=e.parentField||d._parentField,o=e.childrenField||d._childField,idField=e.idField||d._idField,orderField=e.orderField||d._orderField,f.push(e.parentField||d._parentField),f.push(orderField);for(var u=this.get({order:f}),_=0,p=u.length;_<p;_++){i={},n=u[_];for(k in n)i[k]=n[k];r=i[idField],parentId=i[s]||0,parentId?(a=l[parentId],a.hasOwnProperty(o)?a[o].push(i):a[o]=[i]):h.push(i),l[r]=i}if(e.plain){var c=[],v=e.levelField||d._levelField,y=e.hasChildrenField||d._hasChildrenField,f=e.order;return t(h,0,1),c}return h},DataSet.prototype.getIds=function(e){var t,r,i,n,s,o=this._data,a=e&&e.filter,d=e&&e.order,l=e&&e.type||this._options.type,h=[];if(a)if(d){s=[];for(i in o)o.hasOwnProperty(i)&&(n=this._getItem(i,l),a(n)&&s.push(n));for(this._sort(s,d),t=0,r=s.length;t<r;t++)h[t]=s[t][this._idField]}else for(i in o)o.hasOwnProperty(i)&&(n=this._getItem(i,l),a(n)&&h.push(n[this._idField]));else if(d){s=[];for(i in o)o.hasOwnProperty(i)&&s.push(o[i]);for(this._sort(s,d),t=0,r=s.length;t<r;t++)h[t]=s[t][this._idField]}else for(i in o)o.hasOwnProperty(i)&&(n=o[i],h.push(n[this._idField]));return h},DataSet.prototype.getDataSet=function(){return this},DataSet.prototype.forEach=function(e,t){var r,i=t&&t.filter,n=(t&&t.type||this._options.type,this._data);this._ids;if(t&&t.order)for(var s=this.get(t),o=0,a=s.length;o<a;o++)r=s[o],e(r,o);else for(var o=0,a=n.length;o<a;o++)r=n[o],i&&!i(r)||e(r,o)},DataSet.prototype.map=function(e,t){for(var r,i,n=t&&t.filter,s=(t&&t.type||this._options.type,[]),o=this._data,a=o.length;i<a;i++)r=o[i],n&&!n(r)||s.push(e(r,id));return t&&t.order&&this._sort(s,t.order),s},DataSet.prototype._filterFields=function(e,t){if(!e)return e;var r={};if(Array.isArray(t))for(var i in e)e.hasOwnProperty(i)&&t.indexOf(i)!=-1&&(r[i]=e[i]);else for(var i in e)e.hasOwnProperty(i)&&t.hasOwnProperty(i)&&(r[t[i]]=e[i]);return r},DataSet.prototype._by=function(e,t,r){return t=t||!1,function(i,n){var s,o;if("object"==typeof i&&"object"==typeof n&&i&&n)return s=i[e],o=n[e],s===o?"function"==typeof r?r(i,n):0:typeof s==typeof o?t?s<o?1:-1:s<o?-1:1:0;throw"error"}};var mergesort=function(e,t){function r(r,i,n){"use asm";var s=i-r,o=n-i;var a=e.slice(r,i),d=e.slice(i,n);var l=r,h=0,f=0;while(h<s&&f<o)if(t(a[h],d[f])<=0)e[l++]=a[h++];else e[l++]=d[f++];while(h<s)e[l++]=a[h++];while(f<o)e[l++]=d[f++];return}function i(n,s){"use asm";var o=s-n;if(o<=8){var a=e.slice(n,s);a.sort(t);for(var d=0;d<o;++d)e[n+d]=a[d];return}var l=n+Math.floor(o/2);i(n,l);i(l,s);r(n,l,s)}return void 0===t&&(t=function(e,t){"use asm";return e<t?-1:e===t?0:1}),i(0,e.length),e};DataSet.prototype._sort=function(e,t){if(util.isString(t)||Array.isArray(t)){var r,i,n,s,o=null,a=this;r=util.isString(t)?[t]:t;for(var d=r.length-1;d>-1;d--)i=r[d],i&&"-"===i.charAt(0)?(s=!0,i=i.substr(1)):s=!1,n=o?a._by(i,s,o):a._by(i,s),o=n;return mergesort(e,n)}if("function"==typeof t)return mergesort(e,t);throw new TypeError("Order must be a function or a string")},remove=function(e){var t,r,i,n=[],s=0,o=this,a=function(e){var t,r,i,a;if(e&&(r="string"==typeof e||"number"==typeof e?o.get(e):e,r&&(e=r[o._idField],n.indexOf(e)===-1&&(t=o.index(e),i=r[o._levelField],n.push(e),o._data.splice(t,1),o.length--,o._resetIds(s),o._isTree)))){for(var d=t,l=o.length;d<l&&(a=o._data[t],a[o._levelField]>i);d++)n.push(a[o._idField]),o._data.splice(t,1),o.length--;o._resetParent(t)}};if(Array.isArray(e))for(t=0,r=e.length;t<r;t++)i=a(e[t]);else i=a(e);return this._resetIds(s),n.length&&this._trigger("remove",{items:n}),n},DataSet.prototype._resetParent=function(e){var t,r=this;e-1>-1&&(t=r._data[e-1],t[r._hasChildrenField]&&(e<r.length?t[r._hasChildrenField]=r._data[e][r._levelField]>t[r._levelField]:t[r._hasChildrenField]=!1))},DataSet.prototype._resetIds=function(e){e instanceof Object&&(e=e[this._idField]),e||(e=0),this._ids={};for(var t=0,r=this.length;t<r;t++)this._ids[this._data[t][this._idField]]=t},DataSet.prototype.clear=function(e){var t=Object.keys(this._ids);return this._data=[],this._ids={},this.length=0,this._trigger("remove",{items:t},e),t},DataSet.prototype._addItem=function(e,t,r){var i=e[this._idField];if(void 0!=i){if(this._ids.hasOwnProperty(i))throw new Error("Cannot add item: item with id "+i+" already exists")}else i=util.uuid.v4(),e[this._idField]=i;var n={};for(var s in e)if(e.hasOwnProperty(s)){var o=this._type[s];n[s]=util.convert(e[s],o)}t&&this._isTree||(this._data.push(n),this.length++,this._ids[i]=this.length-1);var a,d;return this._isTree&&(t?(d=this.index(t),n[this._parentField]=t[this._idField],n[this._levelField]||(n[this._levelField]=t[this._levelField]+1),t=this._data[d],t[this._hasChildrenField]=!0,a=this._getFirstChild(t),a?"first"==r?i=this._insertItem(n,d+1,"before").id:(d=this._findNext(d),d==-1&&(d=this.length-1),i=this._insertItem(n,d-1,"after").id):(n[this._orderField]=1,this._data.splice(d+1,0,n),this.length++),this._resetIds()):n[this._levelField]||(n[this._levelField]=0)),i},DataSet.prototype._getFirstChild=function(e){var t,r=e[this._levelField],i=this.index(e);if(i+1<this.length&&(t=this._data[i+1],t[this._levelField]>r))return t},DataSet.prototype.index=function(e){var t;return util.isNumber(e)||util.isString(e)?t=e:e instanceof Object&&(t=e[this._idField]),this._ids[t]},DataSet.prototype._getItem=function(e,t){var r,i,n=this._ids[e],s=this._data[n];if(!s)return null;var o={};if(t)for(r in s)s.hasOwnProperty(r)&&(i=s[r],o[r]=util.convert(i,t[r]));else for(r in s)s.hasOwnProperty(r)&&(i=s[r],o[r]=i);return o},DataSet.prototype._updateItem=function(e){var t=e[this._idField];if(void 0==t)throw new Error("Cannot update item: item has no id (item: "+JSON.stringify(e)+")");var r=this._ids[t],i=this._data[r];if(!i)throw new Error("Cannot update item: no item with id "+t+" found");for(var n in e){var s=this._type[n];i[n]=util.convert(e[n],s)}return t};var util=new Util;