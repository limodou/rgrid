riot.tag2("rtable",'<yield></yield> <div class="{rtable-root:true, zebra:theme==\'zebra\'}" riot-style="width:{width-1}px;height:{height-1}px"> <div class="rtable-header rtable-fixed" riot-style="width:{fix_width}px;height:{header_height}px"> <div each="{fix_columns}" no-reorder class="{rtable-cell:true}" riot-style="width:{width}px;height:{height}px;left:{left}px;top:{top}px;line-height:{height}px;"> <div if="{type!=\'check\'}" data-is="rtable-raw" class="rtable-cell-text" value="{title}" riot-style="{sort?\'padding-right:22px\':\'\'}"></div> <input if="{type==\'check\' && parent.multiSelect}" type="checkbox" onclick="{checkall}" class="rtable-check" riot-style="margin-top:{headerRowHeight/2-7}px" __checked="{parent.selected_rows.length>0}"></input> <div if="{!fixed && leaf}" class="rtable-resizer" onmousedown="{colresize}"></div> <div if="{sort}" class="{rtable-sort:true, desc:get_sorted(name)==\'desc\', asc:get_sorted(name)==\'asc\'}" title="{sort}" onclick="{sort_handler}" riot-style="top:{get_sort_top(get_sorted(name))}px"></div> </div> </div> <div class="rtable-header rtable-main" riot-style="width:{width-fix_width-xscroll_width}px;right:0px;height:{header_height}px;left:{fix_width}px;"> <div each="{main_columns}" no-reorder class="{rtable-cell:true}" riot-style="width:{width}px;height:{height}px;left:{left}px;top:{top}px;line-height:{height}px;"> <div if="{type!=\'check\'}" data-is="rtable-raw" class="rtable-cell-text" value="{title}" riot-style="{sort?\'padding-right:22px\':\'\'}"></div> <input if="{type==\'check\' && parent.multiSelect}" type="checkbox" onclick="{checkall}" class="rtable-check" riot-style="margin-top:{headerRowHeight/2-7}px" __checked="{parent.selected_rows.length>0}"></input> <div if="{!fixed && leaf}" class="rtable-resizer" onmousedown="{colresize}"></div> <div if="{sort}" class="{rtable-sort:true, desc:get_sorted(name)==\'desc\', asc:get_sorted(name)==\'asc\'}" title="{sort}" onclick="{sort_handler}" riot-style="top:{get_sort_top(get_sorted(name))}px;"></div> </div> </div> <div class="rtable-body rtable-fixed" riot-style="width:{fix_width}px;bottom:{xscroll_width}px;top:{header_height}px;height:{height-header_height-xscroll_width}px;"> <div class="rtable-content" riot-style="width:{fix_width}px;height:{rows.length*rowHeight}px;"> <div each="{row in visCells.fixed}" no-reorder class="{get_row_class(row.row, row.line)}"> <div each="{col in row.cols}" no-reorder class="{get_cell_class(col)}" riot-style="width:{col.width}px;height:{col.height}px;left:{col.left}px;top:{col.top}px;line-height:{col.height}px;text-align:{col.align};"> <div data-is="rtable-cell" if="{col.type!=\'check\' && !col.buttons}" tag="{col.tag}" value="{col.__value__}" row="{col.row}" col="{col}" riot-style="{col.indentWidth}"></div> <span if="{col.expander}" data-is="rtable-raw" content="{col.expander}" class="rtable-expander" riot-style="left:{col.indent-12}px;" onclick="{toggle_expand}"></span> <input if="{col.type==\'check\'}" type="checkbox" onclick="{checkcol}" __checked="{is_selected(col.row)}" class="rtable-check" riot-style="margin-top:{rowHeight/2-7}px"></input> </div> </div> </div> </div> <div class="rtable-body rtable-main" onscroll="{scrolling}" riot-style="left:{fix_width}px;top:{header_height}px;bottom:0px;right:0px;width:{width-fix_width+yscroll_fix}px;height:{height-header_height+xscroll_fix}px;"> <div class="rtable-content" riot-style="width:{main_width}px;height:{rows.length*rowHeight}px;"> <div each="{row in visCells.main}" no-reorder class="{get_row_class(row.row, row.line)}"> <div each="{col in row.cols}" no-reorder class="{get_cell_class(col)}" riot-style="width:{col.width}px;height:{col.height}px;left:{col.left}px;top:{col.top}px;line-height:{col.height}px;text-align:{col.align};"> <div data-is="rtable-cell" if="{col.type!=\'check\' && !col.buttons}" tag="{col.tag}" value="{col.__value__}" row="{col.row}" col="{col}" riot-style="{col.indentWidth}"></div> <span if="{col.expander}" data-is="rtable-raw" value="{col.expander}" class="rtable-expander" riot-style="left:{col.indent-12}px;" onclick="{toggle_expand}"></span> <input if="{col.type==\'check\'}" type="checkbox" onclick="{checkcol}" __checked="{is_selected(col.row)}" class="rtable-check" riot-style="margin-top:{rowHeight/2-7}px;"></input> <virtual if="{col.buttons}" no-reorder each="{btn in col.buttons}"> <i if="{btn.icon}" class="fa fa-{btn.icon} action" title="{btn.title}" onclick="{parent.parent.action_click(parent.col, btn)}"></i> <a if="{btn.label}" class="action" title="{btn.title}" href="{btn.href || \'#\'}" onclick="{parent.parent.action_click(parent.col, btn)}">{btn.label}</a> </virtual> </div> </div> </div> </div> <div if="{rows.length==0}" data-is="rtable-raw" value="{noData}" class="rtable-nodata" riot-style="top:{height/2-header_height/2+rowHeight/2}px;"></div> </div> </div>','rtable .action,[riot-tag="rtable"] .action,[data-is="rtable"] .action{cursor:pointer;} rtable .rtable-root,[riot-tag="rtable"] .rtable-root,[data-is="rtable"] .rtable-root{ position:relative; border: 1px solid gray; overflow:hidden; } rtable .rtable-header,[riot-tag="rtable"] .rtable-header,[data-is="rtable"] .rtable-header{ position:absolute; box-sizing: border-box; } rtable .rtable-header.rtable-fixed,[riot-tag="rtable"] .rtable-header.rtable-fixed,[data-is="rtable"] .rtable-header.rtable-fixed{ left:0; top:0; } rtable .rtable-header.rtable-main,[riot-tag="rtable"] .rtable-header.rtable-main,[data-is="rtable"] .rtable-header.rtable-main{ top:0; overflow:hidden; } rtable .rtable-content,[riot-tag="rtable"] .rtable-content,[data-is="rtable"] .rtable-content{ overflow: hidden; } rtable .rtable-cell,[riot-tag="rtable"] .rtable-cell,[data-is="rtable"] .rtable-cell{ position:absolute; box-sizing: border-box; border-right:1px solid gray; border-bottom:1px solid gray; background-color: white; white-space: nowrap; text-overflow: ellipsis; } rtable .rtable-cell-text-wrapper,[riot-tag="rtable"] .rtable-cell-text-wrapper,[data-is="rtable"] .rtable-cell-text-wrapper{ height: 100%; } rtable .rtable-cell-text,[riot-tag="rtable"] .rtable-cell-text,[data-is="rtable"] .rtable-cell-text{ position:relative; padding-left:4px; padding-right:4px; width: 100%; height: 100%; } rtable .rtable-cell-text,[riot-tag="rtable"] .rtable-cell-text,[data-is="rtable"] .rtable-cell-text,rtable .rtable-cell-text>*,[riot-tag="rtable"] .rtable-cell-text>*,[data-is="rtable"] .rtable-cell-text>*{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } rtable .rtable-cell > .rtable-resizer,[riot-tag="rtable"] .rtable-cell > .rtable-resizer,[data-is="rtable"] .rtable-cell > .rtable-resizer{ width:4px; position:absolute; height:100%; cursor: col-resize; top:0px; right:0px; } rtable .rtable-cell.selected,[riot-tag="rtable"] .rtable-cell.selected,[data-is="rtable"] .rtable-cell.selected{ background-color:#ffefd5; } rtable .rtable-cell .rtable-check,[riot-tag="rtable"] .rtable-cell .rtable-check,[data-is="rtable"] .rtable-cell .rtable-check{ vertical-align: text-bottom; margin-top: 5px; } rtable .rtable-cell .rtable-sort,[riot-tag="rtable"] .rtable-cell .rtable-sort,[data-is="rtable"] .rtable-cell .rtable-sort,rtable .rtable-cell .rtable-sort.desc,[riot-tag="rtable"] .rtable-cell .rtable-sort.desc,[data-is="rtable"] .rtable-cell .rtable-sort.desc,rtable .rtable-cell .rtable-sort.asc,[riot-tag="rtable"] .rtable-cell .rtable-sort.asc,[data-is="rtable"] .rtable-cell .rtable-sort.asc{ position: absolute; display: block; content: ""; background-color: transparent; border-left: 1px solid #ccc; border-bottom: 1px solid #ccc; height: 8px; width: 8px; right: 6px; top:6px; z-index: 102; cursor: pointer; -webkit-transform: rotate(45deg); -ms-transform: rotate(45deg); -o-transform: rotate(45deg); transform: rotate(45deg); } rtable .rtable-cell .rtable-sort.desc,[riot-tag="rtable"] .rtable-cell .rtable-sort.desc,[data-is="rtable"] .rtable-cell .rtable-sort.desc{ border-left: 1px solid black; border-bottom: 1px solid black; -webkit-transform: rotate(-45deg); -ms-transform: rotate(-45deg); -o-transform: rotate(-45deg); transform: rotate(-45deg); } rtable .rtable-cell .rtable-sort.asc,[riot-tag="rtable"] .rtable-cell .rtable-sort.asc,[data-is="rtable"] .rtable-cell .rtable-sort.asc{ border-left: 1px solid black; border-bottom: 1px solid black; -webkit-transform: rotate(135deg); -ms-transform: rotate(135deg); -o-transform: rotate(135deg); transform: rotate(135deg); } rtable .rtable-header .rtable-cell,[riot-tag="rtable"] .rtable-header .rtable-cell,[data-is="rtable"] .rtable-header .rtable-cell{ text-align:center; vertical-align: middle; } rtable .rtable-body,[riot-tag="rtable"] .rtable-body,[data-is="rtable"] .rtable-body{ position:absolute; box-sizing: border-box; } rtable .rtable-body.rtable-fixed,[riot-tag="rtable"] .rtable-body.rtable-fixed,[data-is="rtable"] .rtable-body.rtable-fixed{ left:0; overflow: hidden; } rtable .rtable-body.rtable-main,[riot-tag="rtable"] .rtable-body.rtable-main,[data-is="rtable"] .rtable-body.rtable-main{ overflow: auto; } rtable .rtable-nodata,[riot-tag="rtable"] .rtable-nodata,[data-is="rtable"] .rtable-nodata{ position:relative; margin: auto; height: 34px; text-align: center; color: #ccc; line-height: 34px; } rtable .rtable-expander,[riot-tag="rtable"] .rtable-expander,[data-is="rtable"] .rtable-expander{ position:absolute; top:0px; cursor:pointer; font-size:14px; } rtable .rtable-root.zebra .rtable-row.even .rtable-cell,[riot-tag="rtable"] .rtable-root.zebra .rtable-row.even .rtable-cell,[data-is="rtable"] .rtable-root.zebra .rtable-row.even .rtable-cell{ background-color: #f2f2f2; border-bottom:none; border-right:1px solid #ddd; } rtable .rtable-root.zebra .rtable-row.odd .rtable-cell,[riot-tag="rtable"] .rtable-root.zebra .rtable-row.odd .rtable-cell,[data-is="rtable"] .rtable-root.zebra .rtable-row.odd .rtable-cell{ border-bottom:none; border-right:1px solid #ddd; } rtable .rtable-root.zebra .rtable-row.even .rtable-cell.selected,[riot-tag="rtable"] .rtable-root.zebra .rtable-row.even .rtable-cell.selected,[data-is="rtable"] .rtable-root.zebra .rtable-row.even .rtable-cell.selected{ background-color: #ffefd5; } rtable .rtable-root.zebra .rtable-header .rtable-cell,[riot-tag="rtable"] .rtable-root.zebra .rtable-header .rtable-cell,[data-is="rtable"] .rtable-root.zebra .rtable-header .rtable-cell{ background-color: #f2f2f2; } rtable .rtable-root.simple .rtable-row.even .rtable-cell,[riot-tag="rtable"] .rtable-root.simple .rtable-row.even .rtable-cell,[data-is="rtable"] .rtable-root.simple .rtable-row.even .rtable-cell{ } rtable .rtable-root.simple .rtable-row.odd .rtable-cell,[riot-tag="rtable"] .rtable-root.simple .rtable-row.odd .rtable-cell,[data-is="rtable"] .rtable-root.simple .rtable-row.odd .rtable-cell{ } rtable .rtable-root.simple .rtable-row.even .rtable-cell.selected,[riot-tag="rtable"] .rtable-root.simple .rtable-row.even .rtable-cell.selected,[data-is="rtable"] .rtable-root.simple .rtable-row.even .rtable-cell.selected{ } rtable .rtable-root.simple .rtable-header .rtable-cell,[riot-tag="rtable"] .rtable-root.simple .rtable-header .rtable-cell,[data-is="rtable"] .rtable-root.simple .rtable-header .rtable-cell{ }',"",function(t){function e(){var t,e={},r=navigator.userAgent.toLowerCase();return(t=r.match(/rv:([\d.]+)\) like gecko/))?e.ie=t[1]:(t=r.match(/msie ([\d.]+)/))?e.ie=t[1]:(t=r.match(/firefox\/([\d.]+)/))?e.firefox=t[1]:(t=r.match(/chrome\/([\d.]+)/))?e.chrome=t[1]:(t=r.match(/opera.([\d.]+)/))?e.opera=t[1]:(t=r.match(/version\/([\d.]+).*safari/))?e.safari=t[1]:0,e}function r(){var t,e,r=document.createElement("p"),l={width:"100px",height:"100px",overflowY:"scroll"};for(t in l)r.style[t]=l[t];return document.body.appendChild(r),e=r.offsetWidth-r.clientWidth,document.body.removeChild(r),e}function l(t,e,r){var l,a,i,o,n,d,c,h,b,p,g,f=[];if(!t||0===t.length)return[];for(l=0;l<e;l++)f.push([]);for(l=0,a=t.length;l<a;l++)for(o=t[l],n=o.subs.length,c=1,p=-1,i=0;i<n;i++)d=o.subs[i],b={},b.title=d,i==n-1?(b.rowspan=e-(n-1)*c,b.leaf=!0):b.rowspan=c,b.colspan=1,b.level=i,b.col=l,b.width=o.width,b.height=b.rowspan*s.headerRowHeight,b.top=s.headerRowHeight*i,b.frozen=r,b.buttons=o.buttons,b.render=o.render,b.name=o.name,b.real_col=o,b.fixed=o.fixed,b.style=o.style,b.type=o.type,b.sort=o.sort,b.align=o.align||"left",b["class"]=o["class"],b.tag=o.tag||"rtable-raw",b.editor=o.editor,g=f[i].length>0?f[i][f[i].length-1]:null,0==i?(p=-1,h=null):(h=f[i-1][f[i-1].length-1],p=h.col),g&&g.title==b.title&&g.level==b.level&&p<l?(g.colspan++,g.width+=b.width):(f[i].push(b),b.parent_col=h,0==l?b.left=0:g?b.left=g.left+g.width:h?b.left=h.left:b.left=0),o.left=b.left;var u=[];for(l=0;l<e;l++)u=u.concat(f[l]);return u}function a(t){return function(){return s[t].apply(s,arguments)}}function o(t){return function(){return s._data[t].apply(s._data,arguments)}}var s=this;if(this.root.instance=this,t.options)for(var n in t.options)t[n]=t.options[n];this.nameField=t.nameField||"name",this.titleField=t.titleField||"title",this.cols=t.cols.slice(),this.headerRowHeight=t.headerRowHeight||34,this.rowHeight=t.rowHeight||34,this.indexColWidth=t.indexColWidth||40,this.multiSelect=t.multiSelect||!1,this.visCells=[],this.selected_rows=[],this.sort_cols=[],this.clickSelect=void 0===t.clickSelect?"row":t.clickSelect,this.noData=t.noData||"No Data",this.container=t.container||$(this.root).parent(),this.editable=t.editable||!1,this.draggable=t.draggable||!1,this.theme="zebra",this.minColWidth=t.minColWidth||5,this.onUpdate=t.onUpdate||function(){},this.onSort=t.onSort||function(){},this.onRowClass=t.onRowClass||function(){},this.onEdit=t.onEdit||function(){return!0},this.onEdited=t.onEdited||function(){return!0},this.onSelected=t.onSelected||function(){},this.onSelect=t.onSelect||function(){return!0},this.onDeselected=t.onDeselected||function(){},this.tree=t.tree,this.showIcon=void 0===t.showIcon||t.showIcon,t.useFontAwesome?(this.openIcon='<i class="fa fa-minus-square-o"></i>',this.closeIcon='<i class="fa fa-plus-square-o"></i>'):(this.openIcon=t.openIcon||"-",this.closeIcon=t.closeIcon||"+"),this.iconInden=16,this.expanded=void 0!==t.expanded&&t.expanded,this.parents_expand_status={},this.parentField=t.parentField,this.orderField=t.orderField,this.levelField=t.levelField,this.hasChildrenField=t.hasChildrenField,this.indentWidth=16;var d,c={tree:t.tree,parentField:t.parentField,levelField:t.levelField,orderField:t.orderField,hasChildrenField:t.hasChildrenField};if(t.data){if(Array.isArray(t.data))this._data=new DataSet,d=t.data;else{var d=t.data.get();this._data=t.data}t.tree?(this._data.setOption(c),this._data.load_tree(d,{parentField:t.parentField,orderField:t.orderField,levelField:t.levelField,hasChildrenField:t.hasChildrenField,plain:!0})):this._data.load(d)}else this._data=new DataSet(c);this.bind=function(){s._data.on("*",function(t,e){if(s.onUpdate(s._data,t,e),"remove"==t)for(var r,l=e.items,a=0,i=l.length;a<i;a++)r=s.selected_rows.indexOf(l[a].id),r!==-1&&s.selected_rows.splice(r,1);s.ready_data(),s.calData(),s.update()})},this.ready_data=function(){var e=[];if(t.tree||t.remoteSort||!this.sort_cols.length)this.rows=this._data.get();else{for(i=0,len=this.sort_cols.length;i<len;i++)col=this.sort_cols[i],"desc"==col.direction?e.push("-"+col.name):"asc"==col.direction&&e.push(col.name);this.rows=this._data.get({order:e})}},this.on("mount",function(){this.content=this.root.querySelectorAll(".rtable-body.rtable-main")[0],this.header=this.root.querySelectorAll(".rtable-header.rtable-main")[0],this.content_fixed=this.root.querySelectorAll(".rtable-body.rtable-fixed")[0],this.browser=e(),this._updated=!1,window.addEventListener("resize",function(){"auto"!=t.width&&t.width&&t.height||s.resize()}),this.content.addEventListener("mousewheel",function(t){s.mousewheel(t)}),$(this.content).on("click",".rtable-cell",this.click_handler).on("dblclick",".rtable-cell",this.dblclick_handler),$(this.content_fixed).on("click",".rtable-cell",this.click_handler).on("dblclick",".rtable-cell",this.dblclick_handler),this.scrollbar_width=r(),this.ready_data(),this.calSize(),this.calHeader(),this.calData(),this.calScrollbar(),this.bind(),this.update()}),this.on("updated",function(){this._updated||(this._updated=!0,this.resize())}),this.click_handler=function(e){var r,l=e.target._tag;if((!s.editable||!s.editor)&&l){var a=l.opts.col;t.onClick&&(r=t.onClick(a.row,a)),!r&&$(e.target).hasClass("rtable-cell-text")&&(e.preventDefault(),"row"===s.clickSelect?(s.toggle_select(a.row),s.update()):"column"===s.clickSelect)}},this.dblclick_handler=function(e){var r,l,a=$(e.target);if(l=a.hasClass("rtable-cell-text")?e.target:a.parents(".rtable-cell-text")[0]){var i=l._tag;if(i){var o=l._tag.opts.col;if(t.onDblclick&&(r=t.onDblclick(o.row,o)),!r&&(e.preventDefault(),t.editable)){if(!o.editor)return;e.preventUpdate=!0,document.selection&&document.selection.empty&&(document.selection.empty(),1)||window.getSelection&&window.getSelection().removeAllRanges(),b($(l).parent()[0],o.row,o)}}}},this.sort_handler=function(t){var e,r,l;t.preventDefault(),e=t.item.name,0==s.sort_cols.length?r="asc":(l=s.sort_cols[0],r="desc"!=l.direction&&("asc"==l.direction?"desc":"asc")),r?s.sort_cols=[{name:e,direction:r}]:s.sort_cols=[],s.remoteSort?s._data.load(s.onSort.call(s,s.sort_cols)):(s.ready_data(),s.calData())},this.get_sort_top=function(t){var e;return e="asc"==t?(s.headerRowHeight-16)/2+4:"desc"==t?(s.headerRowHeight-16)/2+2:(s.headerRowHeight-16)/2+4},this.colresize=function(t){var e,r=t.clientX,l=$(this.header),a=$(document),i=t.item,o=i.width;document.selection&&document.selection.empty&&(document.selection.empty(),1)||window.getSelection&&window.getSelection().removeAllRanges(),document.body.onselectstart=function(){return!1},l.css("-moz-user-select","none"),a.on("mousemove",function(t){e=Math.max(o+t.clientX-r,s.minColWidth),i.real_col.width=e,s.resize()}).on("mouseup",function(t){document.body.onselectstart=function(){return!0},l.css("-moz-user-select","text"),a.off("mousemove").off("mouseup")})},this.on("update",function(){this.start=t.start||0,this.content&&this.calVis()}),this.calHeader=function(){var e,r,a,i,o,n,d,c,h,b=[],p=[],g=[],f=0;n=0;for(var u=0,_=s.cols.length;u<_&&("__index_col__"==s.cols[u][s.nameField]?c=!0:"__check_col__"==s.cols[u][s.nameField]&&(h=!0),!c||!h);u++);for(t.indexCol&&!c&&(o={render:function(t,e,r){return e.index+1},width:s.indexColWidth,frozen:!0,align:"center"},o[this.nameField]="__index_col__",o[this.titleField]="#",this.cols.unshift(o)),a=0,i=s.cols.length;a<i;a++)if(this.cols[a].frozen){d=!0;break}for(t.checkCol&&!h&&(o={type:"check",width:30,align:"center",frozen:d},o[this.nameField]="__check_col__",o[this.titleField]="_check",t.indexCol?this.cols.splice(1,0,o):this.cols.unshift(o)),a=0,i=this.cols.length;a<i;a++)o=this.cols[a],o.hidden||(o.frozen?b.push(o):p.push(o),o.name=o[this.nameField],o.title=o[this.titleField]||o.name,o.subs=o.title.split("/"),n=Math.max(n,o.subs.length),o.width?f+=o.width:g.push(o));if(g.length>0)for(var w=this.width-f-this.scrollbar_width,x=Math.floor(w/g.length),a=0,i=g.length;a<i;a++)g[a].width=x,a==g.length-1&&(g[a].width=w-(g.length-1)*x);e=l(p,n,!1),r=l(b,n,!0),this.fix_cols=b,this.main_cols=p,this.fix_columns=r,this.main_columns=e,this.max_level=n;for(var o,m=0,v=0,a=0,i=this.cols.length;a<i;a++)o=this.cols[a],o.hidden||(o.frozen?m+=o.width:v+=o.width);this.header_height=this.max_level*this.headerRowHeight,this.fix_width=m,this.main_width=v},this.calSize=function(){"auto"!==t.width&&t.width?this.width=t.width:this.width=$(this.container).width(),t.height?"auto"==t.height||(this.height=t.height):this.height=$(this.container).height()},this.calScrollbar=function(){this.has_yscroll=this.content.scrollHeight>this.content.clientHeight||this.rows.length*this.rowHeight>this.height-this.header_height,this.has_xscroll=this.content.scrollWidth>this.content.clientWidth||this.main_width>this.width-this.fix_width,this.xscroll_width=this.has_xscroll?this.scrollbar_width:0,this.yscroll_width=this.has_yscroll?this.scrollbar_width:0,this.xscroll_fix=this.browser.ie&&this.has_xscroll?this.xscroll_width:0,this.yscroll_fix=this.browser.ie&&this.has_yscroll?this.yscroll_width:0},this.calData=function(){"auto"==t.height&&(this.height=Math.max(1,this.rows.length)*this.rowHeight+this.header_height,t.maxHeight&&(this.height=Math.min(t.maxHeight,this.height)),0==this.rows.length&&t.minHeight&&(this.height=Math.max(t.minHeight,this.height)))},this.calVis=function(){function e(t,e){if(!s.tree)return!1;var r,l,a,i=[];if(r=e[s.parentField],!r)return!1;for(;r;){if(v.hasOwnProperty(r))return v[r];if(!s.opened(r)){for(v[r]=!0,l=0,a=i.length;l<a;l++)v[i[l]]=!0;return!0}i.push(r),r=s._data.get(r)[s.parentField]}for(l=0,a=i.length;l<a;l++)v[i[l]]=!1}var r,l,a,i,o,n,d,c,h,b,p,g,f,u,_,w,x,m,v={};f={},f.top=this.content.scrollTop,f.left=this.content.scrollLeft,f.bottom=f.top+this.height-this.header_height-this.scrollbar_width,f.right=f.left+this.width-this.fix_width-this.scrollbar_width,first=Math.max(Math.floor(this.content.scrollTop/this.rowHeight),0),a=Math.ceil((this.content.scrollTop+this.height-this.header_height)/this.rowHeight);(new Date).getTime();for(i=a-first,u=[],_=[],g=this.rowHeight,n=this.fix_columns.concat(this.main_columns),r=0,b=0;r<i&&first+r<this.rows.length;)if(d=this.rows[first+r],e(this.rows,d))r++;else{for(w={row:d,cols:[],line:first+b},x={row:d,cols:[],line:first+b},u.push(w),_.push(x),p=g*(first+b),l=0,o=n.length;l<o;l++)c=n[l],h={top:p,width:c.width,height:g,left:c.left,row:d,style:c.style,type:c.type,selected:this.is_selected(d),render:c.render,buttons:c.buttons,index:first+r,sor:c.sort,align:c.align,"class":c["class"],tag:c.tag,editor:c.editor,name:c.name},t.treeField==c.name&&t.tree&&(m=d.level||0,d.has_children&&(s.opened(d)?h.expander=s.openIcon:h.expander=s.closeIcon),h.treeField=!0,m++,h.indent=m*s.indentWidth,h.indentWidth="padding-left:"+h.indent+"px"),h.value=d[c.name],h.__value__=this.get_col_data(h,d[c.name]),c.frozen?x.cols.push(h):h.left>f.right||h.right<f.left||w.cols.push(h);r++,b++}this.visCells={fixed:_,main:u}},this.get_sorted=function(t){for(var e,r=0,l=this.sort_cols.length;r<l;r++)if(e=this.sort_cols[r],e.name==t&&e.direction)return e.direction},this.getId=function(t){return s._data.getId(t)},this.toggle_expand=function(t){var e=s.getId(t.item.col.row),r=this.parents_expand_status[e];void 0===r&&(r=this.expanded),this.parents_expand_status[e]=!r,this.update()},this.expand=function(t){s._expand(t,!0)},this.collapse=function(t){s._expand(t,!1)},this._expand=function(t,e){var r,l,a,i=this;if(t)if(Array.isArray(t))for(r=0,l=t.length;r<l;r++)a=i.getId(t[r]),i.parents_expand_status.hasOwnProperty(a)&&(i.parents_expand_status[a]=e);else a=i.getId(t),i.parents_expand_status.hasOwnProperty(a)&&(i.parents_expand_status[a]=e);else for(a in i.parents_expand_status)i.parents_expand_status[a]=e;i.update()},this.opened=function(t){var e,r;return e=t instanceof Object?t.id:t,r=this.parents_expand_status[e],r===!0||r!==!1&&(this.parents_expand_status[e]=this.expanded,this.expanded)},this.scrolling=function(t){return t.preventUpdate=!0,this.header.scrollLeft=this.content.scrollLeft,this.content_fixed.scrollTop=this.content.scrollTop,this.update()};var h=function(t){var e=10,r=40,l=800,a=0,i=0,o=0,s=0;return"detail"in t&&(i=t.detail),"wheelDelta"in t&&(i=-t.wheelDelta/120),"wheelDeltaY"in t&&(i=-t.wheelDeltaY/120),"wheelDeltaX"in t&&(a=-t.wheelDeltaX/120),"axis"in t&&t.axis===t.HORIZONTAL_AXIS&&(a=i,i=0),o=a*e,s=i*e,"deltaY"in t&&(s=t.deltaY),"deltaX"in t&&(o=t.deltaX),(o||s)&&t.deltaMode&&(1==t.deltaMode?(o*=r,s*=r):(o*=l,s*=l)),o&&!a&&(a=o<1?-1:1),s&&!i&&(i=s<1?-1:1),{spinX:a,spinY:i,pixelX:o,pixelY:s}};this.mousewheel=function(t){t.preventDefault();var e=h(event);return Math.abs(e.pixelX)>Math.abs(e.pixelY)?(this.header.scrollLeft=this.header.scrollLeft+e.pixelX,this.content.scrollLeft=this.content.scrollLeft+e.pixelX):(this.header.scrollTop=this.header.scrollTop+e.pixelY,this.content.scrollTop=this.content.scrollTop+e.pixelY),!1},this.checkall=function(t){t.target.checked?s.selected_rows=s._data.getIds():s.selected_rows=[]},this.checkcol=function(t){s.toggle_select(t.item.col.row),t.target.checked=s.is_selected(t.item.col.row),s.update()},this.toggle_select=function(t){this.is_selected(t)?s.deselect(t):s.select(t)},this.select=function(e){var r,l;e||(e=this._data.get()),Array.isArray(e)||(e=[e]);for(var a=0,i=e.length;a<i;a++)r=e[a],l=r instanceof Object?r.id:r,this.selected_rows.indexOf(l)==-1&&this.onSelect(r)&&(t.multiSelect||(s.selected_rows=[]),this.selected_rows.push(l),this.onSelected(r))},this.deselect=function(t){var e,r,l,a=this.selected_rows,i=[];if(t){Array.isArray(t)||(t=[t]);for(var o=0,s=t.length;o<s;o++)l=t[o]instanceof Object?t[o].id:t[o],i.push(l);for(var o=a.length-1;o>-1&&(e=a[o],r=i.indexOf(e),r!=-1&&(a.splice(o,1),i.splice(r,1),this.onDeselected(this._data.get(e))),0!=t.length);o--);}else this.selected_rows=[],this.onDeselected()},this.is_selected=function(t){var e;if(t)return e=t instanceof Object?t.id:t,s.selected_rows.indexOf(e)!==-1},this.root.is_selected=a("is_selected"),this.get_selected=function(){return this._data.get({filter:function(t){return s.selected_rows.indexOf(t.id)!==-1}})},this.root.get_selected=a("get_selected"),this.root.expand=a("expand"),this.root.collapse=a("collapse"),this.resize=function(){s.calSize(),s.calHeader(),s.calData(),s.calScrollbar(),s.header.scrollLeft=s.content.scrollLeft,s.content_fixed.scrollTop=s.content.scrollTop,s.update()},this.root.add=o("add"),this.root.addFirstChild=o("addFirstChild"),this.root.update=o("update"),this.root.remove=o("remove"),this.root.get=o("get"),this.root.load=o("load"),this.root.insertBefore=o("insertBefore"),this.root.insertAfter=o("insertAfter"),this.root.move=o("move"),this.root.diff=o("diff"),this.root.save=o("save"),this.root.setData=function(t){s._data=t,s.bind()}.bind(this),this.get_col_data=function(t,e){return t.render&&"function"==typeof t.render&&(e=t.render(t.row,t,e)),e||""},this.action_click=function(t,e){return function(r){e.onclick&&"function"==typeof e.onclick&&e.onclick.call(r.target,t.row,s.root)}},this.get_cell_class=function(t){var e,r=[];return r.push("rtable-cell"),t.selected&&r.push("selected"),t["class"]&&(e="function"==typeof t["class"]?t["class"](t.row,t,t.value):t["class"],e&&r.push(e)),r.join(" ")},this.get_row_class=function(t,e){var r,l=[];return l.push("rtable-row"),e%2==1?l.push("even"):l.push("odd"),r=this.onRowClass(t,e),r&&l.push(r),l.join(" ")},this.addClass=function(t,e){var r=this[t].split(/\s+/);r.indexOf(e)<0&&r.push(e),this[t]=r.join(" ")},this.removeClass=function(t,e){if(this.hasClass(t,e)){var r=this[t].split(/\s+/);r.splice(r.indexOf(e),1),this[t]=r.join(" ")}},this.hasClass=function(t,e){return this[t].split(/\s+/).indexOf(e)>-1},this.testing=function(){return console.log("testing",arguments),!0};var b=function(t,e,r){var l;l="string"==typeof r.editor?r.editor:r.editor.name,s.editor&&(s.editor.destroy(),s.editor=null);var a=window[l+"_editor"];a&&$.when(s.onEdit()).then(function(l){l&&(s.editor=a.call(s,t,e,r))})}}),riot.tag2("rtable-cell",'<div class="rtable-cell-text {rtable-tree-field:opts.col.treeField}" draggable="{parent.draggable && (!parent.tree || parent.tree && opts.col.treeField) ? ⁗true⁗ : false}" yield></yield> </div>','rtable-cell [draggable],[riot-tag="rtable-cell"] [draggable],[data-is="rtable-cell"] [draggable]{ -moz-user-select: none; -khtml-user-select: none; -webkit-user-select: none; user-select: none; -khtml-user-drag: element; -webkit-user-drag: element; }','class="rtable-cell-text-wrapper"',function(t){function e(t,e){return e.x>t.left&&e.x<t.right&&e.y>t.top&&e.y<t.bottom}function r(t,e,r){t.style.width=e.right-e.left+"px","before"==r?(t.style.left=e.left+"px",t.style.top="0px",t.style.bottom=""):(t.style.top="",t.style.left=e.left+"px",t.style.bottom="0px")}var l=this;this.prevtag=null,this.on("mount",function(){if(t.tag)return this.prevtag=t.tag,l.parent.draggable&&this.dnd(),this.mountedTag=riot.mount(this.root.querySelector("div"),t.tag,t)[0]}),this.dnd=function(){var t=$(this.root).find(".rtable-cell-text[draggable]");t.size()>0&&(t.unbind("dragstart",this.handleDragStart).unbind("dragover",this.handleDragOver).unbind("drop",this.handleDrop),this.parent.browser.ie&&t.unbind("selectstart",this.handleSelectStart),t.bind("dragstart",this.handleDragStart).bind("dragover",this.handleDragOver).bind("drop",this.handleDrop),this.parent.browser.ie&&t.bind("selectstart",this.handleSelectStart))},this.on("update",function(){return l.parent.draggable&&this.dnd(),this.prevtag&&this.prevtag!==t.tag?(this.prevtag=t.tag,this.mountedTag.unmount(!0),this.mountedTag=riot.mount(this.root.querySelector("div"),t.tag,t)[0]):this.mountedTag?(this.mountedTag.opts=t,this.mountedTag.update()):void 0}),this.handleDragStart=function(t){var e=t.target._tag.opts.col;l.start_element=t.target,l.parent.drag_src=e.row,t.originalEvent.dataTransfer.effectAllowed="move"},this.handleSelectStart=function(t){return t.preventDefault(),t.stopPropagation(),this.dragDrop(),!1},this.handleDragOver=function(t){if(t.preventDefault&&t.preventDefault(),!t.target.isSameNode(l.start_element)&&t.target._tag){var a=t.target._tag.opts.col;if(!a.treeField)return!1;var i,o,s,n=a.width,d=a.height,c=l.root.querySelector(".rtable-draggable-helper");if(l.parent._data.isChild(a.row,l.parent.drag_src))return!1;l.parent.to_item=a.row,i={top:0,left:0,right:n,bottom:d/2},o={top:d/2,left:0,right:2*n/5,bottom:d},s={top:d/2,left:2*n/5,right:n,bottom:d};var h={x:t.offsetX,y:t.offsetY},b=e(i,h),p=e(o,h),g=e(s,h);return(b||p||g)&&(c||(c=document.createElement("div"),c.style.position="absolute",c.className="rtable-draggable-helper",c.style.zIndex=1e3,c.style.borderTop="2px solid green",t.target.appendChild(c),l.parent.helper&&($(l.parent.helper).remove(),l.parent.helper=null),l.parent.helper=c),b&&"before"!=l.parent.last_pos?(l.parent.last_pos="before",r(c,i,l.parent.last_pos)):p&&"after"!=l.parent.last_pos?(l.parent.last_pos="after",r(c,o,l.parent.last_pos)):g&&(l.parent.last_pos="child",r(c,s,l.parent.last_pos))),a=t.target._tag.opts.col,t.originalEvent.dataTransfer.dropEffect="move",!1}},this.handleDrop=function(t){var e=l.parent.last_pos;if(e&&(l.parent.helper&&($(l.parent.helper).remove(),l.parent.helper=null,l.parent.last_pos=""),t.currentTarget._tag)){var r=t.currentTarget._tag.opts.col,a=l.parent.drag_src,i=r.row;l.parent.opts.onMove&&l.parent.opts.onMove(a,i,e)}},this.on("unmount",function(){if(this.mountedTag)return this.mountedTag.unmount(!0)})}),riot.tag2("rtable-raw","<span></span>","","",function(t){this.on("mount",function(){this.root.innerHTML=t.value}),this.on("update",function(){this.root.innerHTML=t.value})});