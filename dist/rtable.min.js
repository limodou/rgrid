riot.tag2("rtable",'<yield></yield> <div class="rtable-root" riot-style="width:{width}px;height:{height}px"> <div class="rtable-header rtable-fixed" riot-style="width:{fix_width}px;height:{header_height}px"> <div each="{fix_columns}" no-reorder class="{rtable-cell:true}" riot-style="width:{width}px;height:{height}px;left:{left}px;top:{top}px;line-height:{height}px;"> <div if="{type!=\'check\'}" data-is="raw" content="{title}"></div> <input if="{type==\'check\' && parent.multiSelect}" type="checkbox" onclick="{checkall}" class="rtable-check"></input> <div if="{!fixed && leaf}" class="rtable-resizer" onmousedown="{colresize}"></div> </div> </div> <div class="rtable-header rtable-main" riot-style="width:{width-fix_width-scrollbar_width}px;height:{header_height}px;left:{fix_width}px;"> <div each="{main_columns}" no-reorder class="{rtable-cell:true}" riot-style="width:{width}px;height:{height}px;left:{left}px;top:{top}px;line-height:{height}px;"> <div if="{type!=\'check\'}" data-is="raw" content="{title}"></div> <input if="{type==\'check\' && parent.multiSelect}" type="checkbox" onclick="{checkall}" class="rtable-check"></input> <div if="{!fixed && leaf}" class="rtable-resizer" onmousedown="{colresize}"></div> </div> </div> <div class="rtable-body rtable-fixed" riot-style="width:{fix_width}px;bottom:{scrollbar_width}px;top:{header_height}px;bottom:0px;"> <div class="rtable-content" riot-style="width:{fix_width}px;height:{rows.length*rowHeight}px;"> <div each="{visCells.fixed}" no-reorder class="{rtable-cell:true, selected:selected}" riot-style="width:{width}px;height:{height}px;left:{left}px;top:{top}px;line-height:{height}px;{style}"> <div if="{type!=\'check\' && !buttons}" data-is="raw" content="{value}"></div> <input if="{type==\'check\'}" type="checkbox" onclick="{checkcol}" __checked="{selected}" class="rtable-check"></input> </div> </div> </div> <div class="rtable-body rtable-main" onscroll="{scrolling}" riot-style="left:{fix_width}px;top:{header_height}px;right:0px;bottom:0px;width:{width-fix_width-scrollbar_width}px;"> <div class="rtable-content" riot-style="width:{main_width}px;height:{rows.length*rowHeight}px;"> <div each="{col in visCells.main}" no-reorder class="{rtable-cell:true, selected:col.selected}" riot-style="width:{col.width}px;height:{col.height}px;left:{col.left}px;top:{col.top}px;line-height:{col.height}px;"> <div if="{type!=\'check\' && !col.buttons}" data-is="raw" content="{col.value}"></div> <input if="{type==\'check\'}" type="checkbox" onclick="{checkcol}" __checked="{col.selected}" class="rtable-check"></input> <div if="{col.buttons}" no-reorder each="{btn in col.buttons}"> <i if="{btn.icon}" class="fa fa-{btn.icon} action" title="{btn.title}" onclick="{parent.parent.action_click(parent.col, btn)}"></i> <a if="{btn.label}" class="action" title="{btn.title}" href="{btn.href || \'#\'}" onclick="{parent.parent.action_click(parent.col, btn)}">{btn.label}</a> </div> </div> </div> </div> </div> </div>','rtable .action,[riot-tag="rtable"] .action,[data-is="rtable"] .action{cursor:pointer;} rtable .rtable-root,[riot-tag="rtable"] .rtable-root,[data-is="rtable"] .rtable-root{ position:relative; border: 1px solid gray; box-sizing: border-box; } rtable .rtable-header,[riot-tag="rtable"] .rtable-header,[data-is="rtable"] .rtable-header{ position:absolute; box-sizing: border-box; } rtable .rtable-header.rtable-fixed,[riot-tag="rtable"] .rtable-header.rtable-fixed,[data-is="rtable"] .rtable-header.rtable-fixed{ left:0; top:0; } rtable .rtable-header.rtable-main,[riot-tag="rtable"] .rtable-header.rtable-main,[data-is="rtable"] .rtable-header.rtable-main{ top:0; overflow:hidden; border-right:1px solid gray; } rtable .rtable-cell,[riot-tag="rtable"] .rtable-cell,[data-is="rtable"] .rtable-cell{ position:absolute; box-sizing: border-box; border-right:1px solid gray; border-bottom:1px solid gray; background-color: white; } rtable .rtable-cell>*,[riot-tag="rtable"] .rtable-cell>*,[data-is="rtable"] .rtable-cell>*{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } rtable .rtable-cell > .rtable-resizer,[riot-tag="rtable"] .rtable-cell > .rtable-resizer,[data-is="rtable"] .rtable-cell > .rtable-resizer{ width:4px; position:absolute; height:100%; cursor: col-resize; top:0px; right:0px; } rtable .rtable-cell.selected,[riot-tag="rtable"] .rtable-cell.selected,[data-is="rtable"] .rtable-cell.selected{ background-color:#ffefd5; } rtable .rtable-cell .rtable-check,[riot-tag="rtable"] .rtable-cell .rtable-check,[data-is="rtable"] .rtable-cell .rtable-check{ vertical-align: text-bottom; margin-top: 5px; } rtable .rtable-header .rtable-cell,[riot-tag="rtable"] .rtable-header .rtable-cell,[data-is="rtable"] .rtable-header .rtable-cell{ text-align:center; vertical-align: middle; } rtable .rtable-body,[riot-tag="rtable"] .rtable-body,[data-is="rtable"] .rtable-body{ position:absolute; box-sizing: border-box; } rtable .rtable-body.rtable-fixed,[riot-tag="rtable"] .rtable-body.rtable-fixed,[data-is="rtable"] .rtable-body.rtable-fixed{ left:0; overflow: hidden; } rtable .rtable-body.rtable-main,[riot-tag="rtable"] .rtable-body.rtable-main,[data-is="rtable"] .rtable-body.rtable-main{ overflow: auto; border-right: 1px solid gray; }',"",function(t){function e(){var t,e,i=document.createElement("p"),l={width:"100px",height:"100px",overflowY:"scroll"};for(t in l)i.style[t]=l[t];return document.body.appendChild(i),e=i.offsetWidth-i.clientWidth,document.body.removeChild(i),e}function i(t,e,i){var l,o,a,s,h,n,c,d,b,f,p,u=[];if(!t||0===t.length)return[];for(l=0;l<e;l++)u.push([]);for(l=0,o=t.length;l<o;l++)for(s=t[l],h=s.subs.length,c=1,f=-1,a=0;a<h;a++)n=s.subs[a],b={},b.title=n,a==h-1?(b.rowspan=e-(h-1)*c,b.leaf=!0):b.rowspan=c,b.colspan=1,b.level=a,b.col=l,b.width=s.width,b.height=b.rowspan*r.rowHeight,b.top=r.rowHeight*a,b.frozen=i,b.buttons=s.buttons,b.render=s.render,b.name=s.name,b.real_col=s,b.fixed=s.fixed,b.style=s.style,b.type=s.type,p=u[a].length>0?u[a][u[a].length-1]:null,0==a?(f=-1,d=null):(d=u[a-1][u[a-1].length-1],f=d.col),p&&p.title==b.title&&p.level==b.level&&f<l?(p.colspan++,p.width+=b.width):(u[a].push(b),b.parent_col=d,0==l?b.left=0:b.left=p.left+p.width),s.left=b.left;var g=[];for(l=0;l<e;l++)g=g.concat(u[l]);return g}function l(t){return function(){return t.apply(r,arguments)}}var r=this;this.nameField=t.nameField||"name",this.titleField=t.titleField||"title",this.onUpdate=t.onUpdate||function(){},this.rowHeight=t.rowHeight||24,this.indexColWidth=t.indexColWidth||40,this.multiSelect=t.multiSelect||!1,this.visCells=[],this.selected_rows=[],t.data?Array.isArray(t.data)?(this.rows=new DataSet,this.rows.add(t.data)):this.rows=t.data:this.rows=new DataSet,this.bind=function(t){t.on("*",function(e,i){r.onUpdate(t,e,i),r.update()})},this.on("mount",function(){"auto"!==t.width&&t.width?this.width=t.width:this.width=$(this.root).parent().width(),"auto"!==t.height&&t.height?this.height=t.height:this.height=$(this.root).parent().height(),this.content=this.root.querySelectorAll(".rtable-body.rtable-main")[0],this.header=this.root.querySelectorAll(".rtable-header.rtable-main")[0],this.content_fixed=this.root.querySelectorAll(".rtable-body.rtable-fixed")[0],this.calHeader(),this.bind(this.rows),this.update()}),this.colresize=function(t){var e,i=t.clientX,l=$(this.header),o=$(document),a=t.item,s=a.width;document.selection&&document.selection.empty&&(document.selection.empty(),1)||window.getSelection&&window.getSelection().removeAllRanges(),document.body.onselectstart=function(){return!1},l.css("-moz-user-select","none"),o.on("mousemove",function(t){e=Math.max(s+t.clientX-i,5),a.real_col.width=e,r.calHeader(),r.update()}).on("mouseup",function(t){document.body.onselectstart=function(){return!0},l.css("-moz-user-select","text"),o.off("mousemove").off("mouseup")})},this.on("update",function(){this.start=t.start||0,this.content&&(this.calVis(),console.log("update"))}),this.calHeader=function(){var e,l,o,a,s,h,n,c=[],d=[],b=[],f=0;for(h=0,this.cols=t.cols.slice(),t.indexCol&&(s={render:function(t,e,i){return e.index+1},width:r.indexColWidth,frozen:!0,style:"background-color:whitesmoke;text-align:center;"},s[this.nameField]="#",s[this.titleField]="#",this.cols.push(s)),o=0,a=r.cols.length;o<a;o++)if(r.cols[o].frozen){n=!0;break}for(t.checkCol&&(s={type:"check",width:30,style:"text-align:center;",frozen:n},s[this.nameField]="_check",s[this.titleField]="_check",this.cols.push(s)),o=0,a=r.cols.length;o<a;o++)s=r.cols[o],s.hidden||(s.frozen?c.push(s):d.push(s),s.name=s[this.nameField],s.title=s[this.titleField]||s.name,s.subs=s.title.split("/"),h=Math.max(h,s.subs.length),s.width?f+=s.width:b.push(s));if(b.length>0)for(var p=Math.floor((this.width-f)/b.length),o=0,a=b.length;o<a;o++)b[o].width=p,o==b.length-1&&(b[o].width=this.width-f-(b.length-1)*p);e=i(d,h,!1),l=i(c,h,!0),this.fix_cols=c,this.main_cols=d,this.fix_columns=l,this.main_columns=e,this.max_level=h,this.calPos()},this.calPos=function(){for(var t,i=0,l=0,r=0,o=this.cols.length;r<o;r++)t=this.cols[r],t.hidden||(t.frozen?i+=t.width:l+=t.width);this.header_height=this.max_level*this.rowHeight,this.fix_width=i,this.main_width=l,this.has_yscroll=this.rows.length*this.rowHeight>this.height-this.header_height,this.has_xscroll=this.main_width>this.width-this.fix_width,this.scrollbar_width=e()},this.calVis=function(){var t,e,i,l,r,o,a,s,h,n,c,d,b,f;first=Math.max(Math.floor(this.content.scrollTop/this.rowHeight),0),i=Math.ceil((this.content.scrollTop+this.height-this.header_height)/this.rowHeight);(new Date).getTime();for(d=this.rows.get().slice(first,i),n=[],c=[],f=this.rowHeight,o=this.fix_columns.concat(this.main_columns),t=0,l=d.length;t<l;t++)for(a=d[t],b=f*(first+t),e=0,r=o.length;e<r;e++)s=o[e],h={top:b,width:s.width,height:f,left:s.left,row:a,style:s.style,type:s.type,selected:this.is_selected(a),render:s.render,buttons:s.buttons,index:first+t},h.value=this.get_col_data(h,a[s.name]),s.frozen?c.push(h):n.push(h);this.visCells={fixed:c,main:n}},this.scrolling=function(t){return t.preventUpdate=!0,this.header.scrollLeft=this.content.scrollLeft,this.content_fixed.scrollTop=this.content.scrollTop,this.update()},this.checkall=function(t){t.target.checked?r.selected_rows=r.rows.getIds():r.selected_rows=[]},this.checkcol=function(t){t.target.checked?r.select(t.item.row):r.deselect(t.item.row)},this.select=function(e){var i,l;t.multiSelect||(r.selected_rows=[]),e||(e=this.rows.get()),Array.isArray(e)||(e=[e]);for(var o=0,a=e.length;o<a;o++)i=e[o],l=i instanceof Object?i.id:i,this.selected_rows.indexOf(l)==-1&&this.selected_rows.push(l)},this.deselect=function(t){var e,i,l,r=this.selected_rows,o=[];if(t){Array.isArray(t)||(t=[t]);for(var a=0,s=t.length;a<s;a++)l=t[a]instanceof Object?t[a].id:t[a],o.push(l);for(var a=r.length-1;a>-1&&(e=r[a],i=o.indexOf(e),i!=-1&&(r.splice(a,1),o.splice(i,1)),0!=t.length);a--);}else this.selected_rows=[]},this.is_selected=function(t){var e;if(t)return e=t instanceof Object?t.id:t,r.selected_rows.indexOf(e)!==-1},this.root.is_selected=l(this.is_selected),this.get_selected=function(){return this.rows.get({filter:function(t){return r.selected_rows.indexOf(t.id)!==-1}})},this.root.get_selected=l(this.get_selected),this.root.load=function(t){r.rows.clear(),r.rows.add(t)}.bind(this),this.root.change=function(t){r.rows.update(t)}.bind(this),this.root.setData=function(t){r.rows=t,r.bind(r.rows)}.bind(this),this.get_col_data=function(t,e){return t.render&&"function"==typeof t.render?t.render(t.row,t,e):e},this.action_click=function(t,e){return function(i){e.onclick&&"function"==typeof e.onclick&&e.onclick.call(i.target,t.row,r)}}}),riot.tag2("raw","<span></span>","","",function(t){this.on("mount",function(){this.root.innerHTML=t.content}),this.on("update",function(){this.root.innerHTML=t.content})});